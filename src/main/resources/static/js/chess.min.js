var Chess=function(T){function U(a){"undefined"===typeof a&&(a=!1);d=Array(128);n={w:-1,b:-1};m="w";k={w:0,b:0};z=-1;x=0;B=1;C=[];a||(q={});L(H())}function I(a,b){"undefined"===typeof b&&(b=!1);var c=a.split(/\s+/),e=c[0],f=0;if(!V(a).valid)return!1;U(b);for(var l=0;l<e.length;l++){var d=e.charAt(l);if("/"===d)f+=8;else if(-1!=="0123456789".indexOf(d))f+=parseInt(d,10);else{var u="a">d?"w":"b";W({type:d.toLowerCase(),color:u},v(f));f++}}m=c[1];-1<c[2].indexOf("K")&&(k.w|=g.KSIDE_CASTLE);-1<c[2].indexOf("Q")&&
(k.w|=g.QSIDE_CASTLE);-1<c[2].indexOf("k")&&(k.b|=g.KSIDE_CASTLE);-1<c[2].indexOf("q")&&(k.b|=g.QSIDE_CASTLE);z="-"===c[3]?-1:h[c[3]];x=parseInt(c[4],10);B=parseInt(c[5],10);L(H());return!0}function V(a){var b={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",
7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"Illegal en-passant square"};a=a.split(/\s+/);if(6!==a.length)return{valid:!1,error_number:1,error:b[1]};if(isNaN(a[5])||0>=parseInt(a[5],10))return{valid:!1,error_number:2,error:b[2]};if(isNaN(a[4])||0>parseInt(a[4],10))return{valid:!1,error_number:3,
error:b[3]};if(!/^(-|[abcdefgh][36])$/.test(a[3]))return{valid:!1,error_number:4,error:b[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(a[2]))return{valid:!1,error_number:5,error:b[5]};if(!/^(w|b)$/.test(a[1]))return{valid:!1,error_number:6,error:b[6]};var c=a[0].split("/");if(8!==c.length)return{valid:!1,error_number:7,error:b[7]};for(var e=0;e<c.length;e++){for(var f=0,l=!1,d=0;d<c[e].length;d++)if(isNaN(c[e][d])){if(!/^[prnbqkPRNBQK]$/.test(c[e][d]))return{valid:!1,error_number:9,error:b[9]};f+=1;l=
!1}else{if(l)return{valid:!1,error_number:8,error:b[8]};f+=parseInt(c[e][d],10);l=!0}if(8!==f)return{valid:!1,error_number:10,error:b[10]}}return"3"==a[3][1]&&"w"==a[1]||"6"==a[3][1]&&"b"==a[1]?{valid:!1,error_number:11,error:b[11]}:{valid:!0,error_number:0,error:b[0]}}function H(){for(var a=0,b="",c=h.a8;c<=h.h1;c++){if(null==d[c])a++;else{0<a&&(b+=a,a=0);var e=d[c].type;b+="w"===d[c].color?e.toUpperCase():e.toLowerCase()}c+1&136&&(0<a&&(b+=a),c!==h.h1&&(b+="/"),a=0,c+=8)}a="";k.w&g.KSIDE_CASTLE&&
(a+="K");k.w&g.QSIDE_CASTLE&&(a+="Q");k.b&g.KSIDE_CASTLE&&(a+="k");k.b&g.QSIDE_CASTLE&&(a+="q");a=a||"-";c=-1===z?"-":v(z);return[b,m,a,c,x,B].join(" ")}function N(a){for(var b=0;b<a.length;b+=2)"string"===typeof a[b]&&"string"===typeof a[b+1]&&(q[a[b]]=a[b+1]);return q}function L(a){0<C.length||("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"!==a?(q.SetUp="1",q.FEN=a):(delete q.SetUp,delete q.FEN))}function X(a){return(a=d[h[a]])?{type:a.type,color:a.color}:null}function W(a,b){if(!("type"in
a&&"color"in a&&-1!=="pnbrqkPNBRQK".indexOf(a.type.toLowerCase())&&b in h))return!1;var c=h[b];if("k"==a.type&&-1!=n[a.color]&&n[a.color]!=c)return!1;d[c]={type:a.type,color:a.color};"k"===a.type&&(n[a.color]=c);L(H());return!0}function Y(a,b,c,e,f){b={color:m,from:b,to:c,flags:e,piece:a[b].type};f&&(b.flags|=g.PROMOTION,b.promotion=f);a[c]?b.captured=a[c].type:e&g.EP_CAPTURE&&(b.captured="p");return b}function w(a){function b(a,b,c,e,f){if("p"!==a[c].type||0!==e>>4&&7!==e>>4)b.push(Y(a,c,e,f));else for(var l=
["q","r","b","n"],d=0,g=l.length;d<g;d++)b.push(Y(a,c,e,f,l[d]))}var c=[],e=m,f="w"===e?"b":"w",l={b:1,w:6},J=h.a8,u=h.h1,r=!1,da="undefined"!==typeof a&&"legal"in a?a.legal:!0;if("undefined"!==typeof a&&"square"in a)if(a.square in h)J=u=h[a.square],r=!0;else return[];for(a=J;a<=u;a++)if(a&136)a+=7;else{var t=d[a];if(null!=t&&t.color===e)if("p"===t.type){var p=a+O[e][0];null==d[p]&&(b(d,c,a,p,g.NORMAL),p=a+O[e][1],l[e]===a>>4&&null==d[p]&&b(d,c,a,p,g.BIG_PAWN));for(E=2;4>E;E++)p=a+O[e][E],p&136||
(null!=d[p]&&d[p].color===f?b(d,c,a,p,g.CAPTURE):p===z&&b(d,c,a,z,g.EP_CAPTURE))}else{var E=0;for(J=Z[t.type].length;E<J;E++){var q=Z[t.type][E];for(p=a;;){p+=q;if(p&136)break;if(null==d[p])b(d,c,a,p,g.NORMAL);else{if(d[p].color===e)break;b(d,c,a,p,g.CAPTURE);break}if("n"===t.type||"k"===t.type)break}}}}r&&u!==n[e]||(k[e]&g.KSIDE_CASTLE&&(l=n[e],u=l+2,null!=d[l+1]||null!=d[u]||F(f,n[e])||F(f,l+1)||F(f,u)||b(d,c,n[e],u,g.KSIDE_CASTLE)),k[e]&g.QSIDE_CASTLE&&(l=n[e],u=l-2,null!=d[l-1]||null!=d[l-2]||
null!=d[l-3]||F(f,n[e])||F(f,l-1)||F(f,u)||b(d,c,n[e],u,g.QSIDE_CASTLE)));if(!da)return c;f=[];a=0;for(J=c.length;a<J;a++)A(c[a]),y(e)||f.push(c[a]),G();return f}function K(a,b){var c="";if(a.flags&g.KSIDE_CASTLE)c="O-O";else if(a.flags&g.QSIDE_CASTLE)c="O-O-O";else{var e=w({legal:!b});for(var f=a.from,l=a.to,d=a.piece,h=0,r=0,k=0,t=0,p=e.length;t<p;t++){var n=e[t].from,q=e[t].to;d===e[t].piece&&f!==n&&l===q&&(h++,f>>4===n>>4&&r++,(f&15)===(n&15)&&k++)}e=0<h?0<r&&0<k?v(f):0<k?v(f).charAt(1):v(f).charAt(0):
"";"p"!==a.piece&&(c+=a.piece.toUpperCase()+e);a.flags&(g.CAPTURE|g.EP_CAPTURE)&&("p"===a.piece&&(c+=v(a.from)[0]),c+="x");c+=v(a.to);a.flags&g.PROMOTION&&(c+="="+a.promotion.toUpperCase())}A(a);y(m)&&(c=y(m)&&0===w().length?c+"#":c+"+");G();return c}function P(a){return a.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function F(a,b){for(var c=h.a8;c<=h.h1;c++)if(c&136)c+=7;else if(null!=d[c]&&d[c].color===a){var e=d[c],f=c-b,l=f+119;if(ea[l]&1<<fa[e.type])if("p"===e.type)if(0<f){if("w"===e.color)return!0}else{if("b"===
e.color)return!0}else{if("n"===e.type||"k"===e.type)return!0;e=ha[l];f=c+e;for(l=!1;f!==b;){if(null!=d[f]){l=!0;break}f+=e}if(!l)return!0}}return!1}function y(a){return F("w"===a?"b":"w",n[a])}function Q(){for(var a={},b=[],c=0,e=0,f=h.a8;f<=h.h1;f++)if(e=(e+1)%2,f&136)f+=7;else{var l=d[f];l&&(a[l.type]=l.type in a?a[l.type]+1:1,"b"===l.type&&b.push(e),c++)}if(2===c||3===c&&(1===a.b||1===a.n))return!0;if(c===a.b+2){a=0;c=b.length;for(f=0;f<c;f++)a+=b[f];if(0===a||a===c)return!0}return!1}function R(){for(var a=
[],b={},c=!1;;){var e=G();if(!e)break;a.push(e)}for(;;){e=H().split(" ").slice(0,4).join(" ");b[e]=e in b?b[e]+1:1;3<=b[e]&&(c=!0);if(!a.length)break;A(a.pop())}return c}function A(a){var b=m,c="w"===b?"b":"w";C.push({move:a,kings:{b:n.b,w:n.w},turn:m,castling:{b:k.b,w:k.w},ep_square:z,half_moves:x,move_number:B});d[a.to]=d[a.from];d[a.from]=null;a.flags&g.EP_CAPTURE&&("b"===m?d[a.to-16]=null:d[a.to+16]=null);a.flags&g.PROMOTION&&(d[a.to]={type:a.promotion,color:b});if("k"===d[a.to].type){n[d[a.to].color]=
a.to;if(a.flags&g.KSIDE_CASTLE){var e=a.to-1,f=a.to+1;d[e]=d[f];d[f]=null}else a.flags&g.QSIDE_CASTLE&&(e=a.to+1,f=a.to-2,d[e]=d[f],d[f]=null);k[b]=""}if(k[b])for(e=0,f=D[b].length;e<f;e++)if(a.from===D[b][e].square&&k[b]&D[b][e].flag){k[b]^=D[b][e].flag;break}if(k[c])for(e=0,f=D[c].length;e<f;e++)if(a.to===D[c][e].square&&k[c]&D[c][e].flag){k[c]^=D[c][e].flag;break}z=a.flags&g.BIG_PAWN?"b"===m?a.to-16:a.to+16:-1;"p"===a.piece?x=0:a.flags&(g.CAPTURE|g.EP_CAPTURE)?x=0:x++;"b"===m&&B++;m="w"===m?"b":
"w"}function G(){var a=C.pop();if(null==a)return null;var b=a.move;n=a.kings;m=a.turn;k=a.castling;z=a.ep_square;x=a.half_moves;B=a.move_number;a=m;var c="w"===m?"b":"w";d[b.from]=d[b.to];d[b.from].type=b.piece;d[b.to]=null;b.flags&g.CAPTURE?d[b.to]={type:b.captured,color:c}:b.flags&g.EP_CAPTURE&&(d["b"===a?b.to-16:b.to+16]={type:"p",color:c});if(b.flags&(g.KSIDE_CASTLE|g.QSIDE_CASTLE)){if(b.flags&g.KSIDE_CASTLE){var e=b.to+1;var f=b.to-1}else b.flags&g.QSIDE_CASTLE&&(e=b.to-2,f=b.to+1);d[e]=d[f];
d[f]=null}return b}function S(a,b){var c=P(a);if(b){var e=c.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(e)var f=e[1],l=e[2],d=e[3],g=e[4]}for(var r=w(),k=0,m=r.length;k<m;k++)if(c===P(K(r[k]))||b&&c===P(K(r[k],!0))||!(!e||f&&f.toLowerCase()!=r[k].piece||h[l]!=r[k].from||h[d]!=r[k].to||g&&g.toLowerCase()!=r[k].promotion))return r[k];return null}function v(a){var b=a&15;a>>=4;return"abcdefgh".substring(b,b+1)+"87654321".substring(a,a+1)}function M(a){a=aa(a);a.san=K(a,!1);
a.to=v(a.to);a.from=v(a.from);var b="",c;for(c in g)g[c]&a.flags&&(b+=ba[c]);a.flags=b;return a}function aa(a){var b=a instanceof Array?[]:{},c;for(c in a)b[c]="object"===typeof c?aa(a[c]):a[c];return b}function ca(a){for(var b=w({legal:!1}),c=0,e=m,f=0,d=b.length;f<d;f++){A(b[f]);if(!y(e))if(0<a-1){var g=ca(a-1);c+=g}else c++;G()}return c}var ia=["1-0","0-1","1/2-1/2","*"],O={b:[16,32,17,15],w:[-16,-32,-17,-15]},Z={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,
1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ea=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,
0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],ha=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,
-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],fa={p:0,n:1,b:2,r:3,q:4,k:5},ba={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},g={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},h={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,
b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},D={w:[{square:h.a1,flag:g.QSIDE_CASTLE},{square:h.h1,flag:g.KSIDE_CASTLE}],b:[{square:h.a8,flag:g.QSIDE_CASTLE},{square:h.h8,flag:g.KSIDE_CASTLE}]},d=Array(128),n={w:-1,b:-1},m="w",k={w:0,b:0},z=-1,x=0,B=1,C=[],q={};"undefined"===typeof T?I("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"):
I(T);return{WHITE:"w",BLACK:"b",PAWN:"p",KNIGHT:"n",BISHOP:"b",ROOK:"r",QUEEN:"q",KING:"k",SQUARES:function(){for(var a=[],b=h.a8;b<=h.h1;b++)b&136?b+=7:a.push(v(b));return a}(),FLAGS:ba,load:function(a){return I(a)},reset:function(){I("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")},moves:function(a){for(var b=w(a),c=[],e=0,f=b.length;e<f;e++)"undefined"!==typeof a&&"verbose"in a&&a.verbose?c.push(M(b[e])):c.push(K(b[e],!1));return c},in_check:function(){return y(m)},in_checkmate:function(){return y(m)&&
0===w().length},in_stalemate:function(){return!y(m)&&0===w().length},in_draw:function(){return 100<=x||!y(m)&&0===w().length||Q()||R()},insufficient_material:function(){return Q()},in_threefold_repetition:function(){return R()},game_over:function(){return 100<=x||y(m)&&0===w().length||!y(m)&&0===w().length||Q()||R()},validate_fen:function(a){return V(a)},fen:function(){return H()},board:function(){for(var a=[],b=[],c=h.a8;c<=h.h1;c++)null==d[c]?b.push(null):b.push({type:d[c].type,color:d[c].color}),
c+1&136&&(a.push(b),b=[],c+=8);return a},pgn:function(a){var b="object"===typeof a&&"string"===typeof a.newline_char?a.newline_char:"\n";a="object"===typeof a&&"number"===typeof a.max_width?a.max_width:0;var c=[],e=!1,f;for(f in q)c.push("["+f+' "'+q[f]+'"]'+b),e=!0;e&&C.length&&c.push(b);for(f=[];0<C.length;)f.push(G());e=[];for(var d="";0<f.length;){var g=f.pop();C.length||"b"!==g.color?"w"===g.color&&(d.length&&e.push(d),d=B+"."):d=B+". ...";d=d+" "+K(g,!1);A(g)}d.length&&e.push(d);"undefined"!==
typeof q.Result&&e.push(q.Result);if(0===a)return c.join("")+e.join(" ");for(f=d=0;f<e.length;f++)d+e[f].length>a&&0!==f?(" "===c[c.length-1]&&c.pop(),c.push(b),d=0):0!==f&&(c.push(" "),d++),c.push(e[f]),d+=e[f].length;return c.join("")},load_pgn:function(a,b){function c(a){return a.replace(/\\/g,"\\")}function e(a){for(var b in a)return!0;return!1}var f="undefined"!==typeof b&&"sloppy"in b?b.sloppy:!1,d="object"===typeof b&&"string"===typeof b.newline_char?b.newline_char:"\r?\n",g=new RegExp("^(\\[((?:"+
c(d)+")|.)*\\])(?:"+c(d)+"){2}");g=g.test(a)?g.exec(a)[1]:"";I("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");var k=function(a,b){for(var e={},d=a.split(new RegExp(c("object"===typeof b&&"string"===typeof b.newline_char?b.newline_char:"\r?\n"))),f,g,h=0;h<d.length;h++)f=d[h].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),g=d[h].replace(/^\[[A-Za-z]+\s"(.*)" *\]$/,"$1"),0<f.replace(/^\s+|\s+$/g,"").length&&(e[f]=g);return e}(g,b),h;for(h in k)N([h,k[h]]);if("1"===k.SetUp&&!("FEN"in k&&I(k.FEN,
!0)))return!1;d=a.replace(g,"").replace(new RegExp(c(d),"g")," ");d=d.replace(/(\{[^}]+\})+?/g,"");for(h=/(\([^\(\)]+\))+?/g;h.test(d);)d=d.replace(h,"");d=d.replace(/\d+\.(\.\.)?/g,"");d=d.replace(/\.\.\./g,"");d=d.replace(/\$\d+/g,"");d=d.replace(/^\s+|\s+$/g,"").split(new RegExp(/\s+/));d=d.join(",").replace(/,,+/g,",").split(",");h="";for(g=0;g<d.length-1;g++){h=S(d[g],f);if(null==h)return!1;A(h)}h=d[d.length-1];if(-1<ia.indexOf(h))e(q)&&"undefined"===typeof q.Result&&N(["Result",h]);else{h=S(h,
f);if(null==h)return!1;A(h)}return!0},header:function(){return N(arguments)},ascii:function(){for(var a="   +------------------------+\n",b=h.a8;b<=h.h1;b++){0===(b&15)&&(a+=" "+"87654321"[b>>4]+" |");if(null==d[b])a+=" . ";else{var c=d[b].type;c="w"===d[b].color?c.toUpperCase():c.toLowerCase();a+=" "+c+" "}b+1&136&&(a+="|\n",b+=8)}return a+"   +------------------------+\n     a  b  c  d  e  f  g  h\n"},turn:function(){return m},move:function(a,b){var c="undefined"!==typeof b&&"sloppy"in b?b.sloppy:
!1,e=null;if("string"===typeof a)e=S(a,c);else if("object"===typeof a){c=w();for(var d=0,g=c.length;d<g;d++)if(!(a.from!==v(c[d].from)||a.to!==v(c[d].to)||"promotion"in c[d]&&a.promotion!==c[d].promotion)){e=c[d];break}}if(!e)return null;c=M(e);A(e);return c},undo:function(){var a=G();return a?M(a):null},clear:function(){return U()},put:function(a,b){return W(a,b)},get:function(a){return X(a)},remove:function(a){var b=X(a);d[h[a]]=null;b&&"k"===b.type&&(n[b.color]=-1);L(H());return b},perft:function(a){return ca(a)},
square_color:function(a){return a in h?(a=h[a],0===((a>>4)+(a&15))%2?"light":"dark"):null},history:function(a){var b=[],c=[];a="undefined"!==typeof a&&"verbose"in a&&a.verbose;for(;0<C.length;)b.push(G());for(;0<b.length;){var d=b.pop();a?c.push(M(d)):c.push(K(d));A(d)}return c}}};"undefined"!==typeof exports&&(exports.Chess=Chess);"undefined"!==typeof define&&define(function(){return Chess});